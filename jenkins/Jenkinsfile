pipeline {
    agent any
    parameters {
        string(name: 'VERSION', defaultValue: 'latest', description: 'Docker image version')
    }
    environment {
        REGISTRY = 'prasoonshrama25'
        IMAGE = 'cronjob-app'
        TAG = "${params.VERSION}" // Use the version parameter for tagging
        DOCKER_CREDENTIALS_ID = 'docker-credentials-id'
        KUBE_CONFIG = credentials('kubeconfig')
    }
    stages {
        stage('Ensure Namespaces are Correctly Labeled') {
            steps {
                script {
                    bat '''
                        kubectl label namespace cronjob-v1 app.kubernetes.io/managed-by=Helm --overwrite
                        kubectl annotate namespace cronjob-v1 meta.helm.sh/release-name=cronjob-v1 meta.helm.sh/release-namespace=cronjob --overwrite

                        kubectl label namespace cronjob-v2 app.kubernetes.io/managed-by=Helm --overwrite
                        kubectl annotate namespace cronjob-v2 meta.helm.sh/release-name=cronjob-v2 meta.helm.sh/release-namespace=cronjob --overwrite

                        kubectl label namespace cronjob-v3 app.kubernetes.io/managed-by=Helm --overwrite
                        kubectl annotate namespace cronjob-v3 meta.helm.sh/release-name=cronjob-v3 meta.helm.sh/release-namespace=cronjob --overwrite
                    '''
                }
            }
        }
        stage('Deploy CronJobs') {
            steps {
                script {
                    withKubeConfig([credentialsId: 'kubeconfig']) {
                        bat '''
                            echo Deploying cronjob-v1...
                            helm upgrade --install cronjob-v1 ./helm/cronjob-multi-version --namespace cronjob --values ./helm/cronjob-multi-version/values-v1.yaml

                            echo Deploying cronjob-v2...
                            helm upgrade --install cronjob-v2 ./helm/cronjob-multi-version --namespace cronjob --values ./helm/cronjob-multi-version/values-v2.yaml

                            echo Deploying cronjob-v3...
                            helm upgrade --install cronjob-v3 ./helm/cronjob-multi-version --namespace cronjob --values ./helm/cronjob-multi-version/values-v3.yaml
                        '''
                    }
                }
            }
        }
    }
}
